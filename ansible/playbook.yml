---
# Ansible playbook to provision VM Provisioner server
# Usage: ansible-playbook -i inventory.ini playbook.yml
#
# SSL is enabled by default with domain: beirut-central1.nadimchendy.com

- name: Provision VM Provisioner Server
  hosts: vm_provisioner
  become: true
  gather_facts: true

  vars:
    app_dir: /opt/vm-provisioner
    data_dir: /var/lib/vm-provisioner
    python_version: "3.11"
    app_user: vmprovisioner
    # Ports for VM allocation
    start_port: 2222
    end_port: 2322
    # SSL settings (enabled by default)
    enable_ssl: true
    domain: beirut-central1.nadimchendy.com
    ssl_email: zadzack409@gmail.com
    app_port: 8000

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install system packages
      ansible.builtin.package:
        name:
          - build-essential
          - pkg-config
          - libvirt-dev
          - python3-dev
          - python3-pip
          - git
          - curl
          - jq
          - iptables
          - qemu-utils
          - nginx
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Create application user
      ansible.builtin.user:
        name: "{{ app_user }}"
        shell: /bin/bash
        create_home: true
        comment: "VM Provisioner Service Account"

    - name: Create data directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
      loop:
        - "{{ data_dir }}"
        - "{{ data_dir }}/images"
        - "{{ data_dir }}/instances"
        - "{{ data_dir }}/cloud-init"

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    - name: Install uv
      ansible.builtin.pip:
        name: uv
        executable: pip3
        extra_args: --break-system-packages

    - name: Create Python virtual environment with uv
      ansible.builtin.command:
        cmd: "{{ app_dir }}/.local/bin/uv venv"
        creates: "{{ app_dir }}/.venv"
        chdir: "{{ app_dir }}"

    - name: Copy application files
      ansible.builtin.synchronize:
        src: ../
        dest: "{{ app_dir }}/"
        delete: false
        recursive: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.venv"
          - "--exclude=ansible"
      become: false
      delegate_to: localhost

    - name: Set ownership of application files
      ansible.builtin.file:
        path: "{{ app_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: true

    - name: Create Python virtual environment with uv
      ansible.builtin.command:
        cmd: uv venv
        creates: "{{ app_dir }}/.venv"
        chdir: "{{ app_dir }}"

    - name: Install Python dependencies using uv
      ansible.builtin.command:
        cmd: "{{ app_dir }}/.local/bin/uv add fastapi uvicorn pycdlib jinja2 python-dotenv libvirt-python scrypt"
        chdir: "{{ app_dir }}"

    - name: Create systemd service file
      ansible.builtin.copy:
        dest: /etc/systemd/system/vm-provisioner.service
        content: |
          [Unit]
          Description=VM Provisioner Service
          After=network.target libvirtd.service
          Requires=libvirtd.service

          [Service]
          Type=simple
          User={{ app_user }}
          WorkingDirectory={{ app_dir }}
          Environment="PATH={{ app_dir }}/.venv/bin:/usr/local/bin:/usr/bin:/bin"
          Environment="PYTHONPATH={{ app_dir }}"
          Environment="DATA_DIR={{ data_dir }}"
          ExecStart=/usr/local/bin/uv run uvicorn main:app --host 0.0.0.0 --port {{ app_port }} --proxy-headers --forwarded-allow-ips=*
          Restart=always
          RestartSec=10

          # Libvirt access
          Environment="LIBVIRT_URI=qemu:///system"

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Enable and start vm-provisioner service
      ansible.builtin.systemd:
        name: vm-provisioner
        daemon_reload: true
        enabled: true
        state: started

    - name: Configure iptables for port forwarding
      ansible.builtin.iptables:
        table: nat
        chain: PREROUTING
        protocol: tcp
        destination_port: "{{ item }}"
        jump: ACCEPT
        comment: "VM Provisioner SSH port {{ item }}"
      loop:
        - "{{ range(start_port, end_port + 1)|list }}"
      ignore_errors: true

    # SSL Configuration Tasks
    - name: Create nginx config for HTTP
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/vm-provisioner
        content: |
          server {
              listen 80;
              server_name {{ domain }};

              location / {
                  proxy_pass http://127.0.0.1:{{ app_port }};
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
        mode: '0644'

    - name: Enable nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/vm-provisioner
        dest: /etc/nginx/sites-enabled/vm-provisioner
        state: link
      notify: Reload nginx

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Test nginx config
      ansible.builtin.command:
        cmd: nginx -t
      register: nginx_test
      changed_when: false

    - name: Reload nginx for initial config
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Get SSL certificate with Certbot
      ansible.builtin.command:
        cmd: certbot --nginx -d {{ domain }} --non-interactive --agree-tos --email {{ ssl_email }}
      register: certbot_result
      failed_when: false

    - name: Reload nginx for SSL
      ansible.builtin.systemd:
        name: nginx
        state: reloaded

    - name: Allow HTTPS through firewall
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 443
        jump: ACCEPT
        comment: "Allow HTTPS"

    - name: Allow HTTP through firewall
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 80
        jump: ACCEPT
        comment: "Allow HTTP"

    - name: Download Debian 12 base image
      ansible.builtin.get_url:
        url: https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2
        dest: "{{ data_dir }}/images/debian-12-template.qcow2"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      ignore_errors: true

    - name: Download Rocky Linux 9 base image
      ansible.builtin.get_url:
        url: https://download.rockylinux.org/pub/rocky/9/BaseOS/x86_64/images/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
        dest: "{{ data_dir }}/images/rocky-9-template.qcow2"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      ignore_errors: true

    - name: Download Alpine Linux base image
      ansible.builtin.get_url:
        url: https://dl.alpinelinux.org/alpine/v3.19/releases/x86_64/alpine-virt-3.19.0-x86_64.qcow2
        dest: "{{ data_dir }}/images/alpine-template.qcow2"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
      ignore_errors: true

    - name: Display service status
      ansible.builtin.service_facts:

    - name: Show completion message
      ansible.builtin.debug:
        msg: |
          ==================================================================
          VM Provisioner has been provisioned!
          ==================================================================
          
          Service status: {{ ansible_facts.services['vm-provisioner.service'].state | default('unknown') }}
          
          Application: {{ app_dir }}
          Data directory: {{ data_dir }}
          
          üåê HTTPS: https://{{ domain }}
          
          ==================================================================
          Useful commands:
            Logs: journalctl -u vm-provisioner -f
            Restart: systemctl restart vm-provisioner
            Status: systemctl status vm-provisioner
          ==================================================================

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
