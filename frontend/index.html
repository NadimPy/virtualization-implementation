<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Provisioner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-bg: #ffffff;
            --color-bg-secondary: #f8f9fb;
            --color-bg-tertiary: #f1f3f5;
            --color-border: #e2e5e9;
            --color-border-light: #eceef1;
            --color-text-primary: #1a1d21;
            --color-text-secondary: #5c6370;
            --color-text-tertiary: #8b919a;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-accent-light: #eff4ff;
            --color-danger: #dc2626;
            --color-danger-hover: #b91c1c;
            --color-danger-light: #fef2f2;
            --color-success: #16a34a;
            --color-success-light: #f0fdf4;
            --color-warning: #d97706;
            --color-warning-light: #fffbeb;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.04);
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-secondary);
            min-height: 100vh;
            color: var(--color-text-primary);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* ---- Top Navigation ---- */
        .topnav {
            background: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
            padding: 0 32px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topnav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 16px;
            color: var(--color-text-primary);
            letter-spacing: -0.02em;
        }

        .topnav-brand svg {
            color: var(--color-accent);
        }

        .topnav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topnav-user {
            font-size: 13px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
            line-height: 1.4;
            white-space: nowrap;
        }

        .btn:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--color-accent);
            color: #fff;
            border-color: var(--color-accent);
        }

        .btn-primary:hover {
            background: var(--color-accent-hover);
            border-color: var(--color-accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--color-bg);
            color: var(--color-text-primary);
            border-color: var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-bg-secondary);
            border-color: #d0d4da;
        }

        .btn-danger {
            background: var(--color-bg);
            color: var(--color-danger);
            border-color: var(--color-border);
        }

        .btn-danger:hover {
            background: var(--color-danger-light);
            border-color: var(--color-danger);
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-text-secondary);
            border-color: transparent;
            padding: 6px 12px;
        }

        .btn-ghost:hover {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }

        .btn-sm {
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn-full {
            width: 100%;
        }

        /* ---- Form Controls ---- */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 6px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-top: 4px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="email"],
        textarea,
        select {
            display: block;
            width: 100%;
            padding: 9px 12px;
            font-family: inherit;
            font-size: 14px;
            color: var(--color-text-primary);
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            line-height: 1.5;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
        }

        input::placeholder, textarea::placeholder {
            color: var(--color-text-tertiary);
        }

        textarea {
            resize: vertical;
            min-height: 72px;
            font-family: var(--font-mono);
            font-size: 13px;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%235c6370' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* ---- Layout ---- */
        .container {
            max-width: 1180px;
            margin: 0 auto;
            padding: 28px 32px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px 16px;
            }
            .topnav {
                padding: 0 16px;
            }
        }

        /* ---- Card ---- */
        .card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            padding: 18px 22px;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .card-body {
            padding: 22px;
        }

        /* ---- Tabs ---- */
        .tab-bar {
            display: flex;
            gap: 2px;
            border-bottom: 1px solid var(--color-border-light);
            padding: 0 22px;
        }

        .tab-item {
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-tertiary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color 0.15s ease, border-color 0.15s ease;
            user-select: none;
        }

        .tab-item:hover {
            color: var(--color-text-secondary);
        }

        .tab-item.active {
            color: var(--color-accent);
            border-bottom-color: var(--color-accent);
        }

        /* ---- VM List ---- */
        .vm-list {
            padding: 12px 22px 22px;
        }

        .vm-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--color-border-light);
        }

        .vm-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .vm-item:first-child {
            padding-top: 4px;
        }

        .vm-info {
            flex: 1;
            min-width: 0;
        }

        .vm-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .vm-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            font-size: 12px;
            color: var(--color-text-tertiary);
        }

        .vm-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vm-meta-label {
            color: var(--color-text-tertiary);
        }

        .vm-meta-value {
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .vm-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            flex-shrink: 0;
            margin-left: 16px;
        }

        .vm-actions {
            display: flex;
            gap: 6px;
        }

        /* ---- Status Badge ---- */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .badge-running {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .badge-running .badge-dot {
            background: var(--color-success);
        }

        .badge-stopped {
            background: var(--color-bg-tertiary);
            color: var(--color-text-tertiary);
        }

        .badge-stopped .badge-dot {
            background: var(--color-text-tertiary);
        }

        .badge-unknown {
            background: var(--color-warning-light);
            color: var(--color-warning);
        }

        .badge-unknown .badge-dot {
            background: var(--color-warning);
        }

        /* ---- Auth Pages ---- */
        .auth-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            background: var(--color-bg-secondary);
        }

        .auth-box {
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .auth-header svg {
            color: var(--color-accent);
            margin-bottom: 16px;
        }

        .auth-header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-text-primary);
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }

        .auth-header p {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .auth-card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
        }

        .auth-footer {
            text-align: center;
            margin-top: 18px;
            font-size: 13px;
            color: var(--color-text-tertiary);
        }

        .auth-footer a {
            color: var(--color-accent);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* ---- API Key Display ---- */
        .api-key-block {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-family: var(--font-mono);
            font-size: 13px;
            word-break: break-all;
            color: var(--color-text-primary);
            margin: 16px 0;
            line-height: 1.6;
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .alert-warning {
            background: var(--color-warning-light);
            border: 1px solid #fde68a;
            color: #92400e;
        }

        /* ---- Empty State ---- */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
        }

        .empty-state svg {
            color: var(--color-text-tertiary);
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--color-text-tertiary);
            font-size: 14px;
        }

        /* ---- Loading Spinner ---- */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 2.5px solid var(--color-border);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---- Toast ---- */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            transform: translateY(80px);
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--color-success);
            color: #fff;
        }

        .toast.error {
            background: var(--color-danger);
            color: #fff;
        }

        /* ---- Utilities ---- */
        .hidden {
            display: none !important;
        }

        .text-mono {
            font-family: var(--font-mono);
        }

        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }

        /* ---- Modal ---- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--color-bg);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(8px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.open .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-border-light);
            position: sticky;
            top: 0;
            background: var(--color-bg);
            z-index: 1;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--color-text-tertiary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .modal-close:hover {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .tutorial-section {
            margin-bottom: 28px;
        }

        .tutorial-section:last-child {
            margin-bottom: 0;
        }

        .tutorial-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tutorial-section p {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .tutorial-section ol {
            font-size: 13px;
            color: var(--color-text-secondary);
            line-height: 1.8;
            padding-left: 18px;
            margin-bottom: 10px;
        }

        .code-block {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--color-text-primary);
            margin: 8px 0;
            position: relative;
            overflow-x: auto;
            line-height: 1.6;
            white-space: pre;
        }

        .code-block .code-copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 3px 8px;
            font-size: 11px;
            font-family: inherit;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .code-block .code-copy-btn:hover {
            background: var(--color-bg-tertiary);
        }

        .os-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 16px;
            background: var(--color-bg-tertiary);
            padding: 3px;
            border-radius: var(--radius-md);
            width: fit-content;
        }

        .os-tab {
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: background 0.15s ease, color 0.15s ease;
            border: none;
            background: none;
            font-family: inherit;
        }

        .os-tab:hover {
            color: var(--color-text-primary);
        }

        .os-tab.active {
            background: var(--color-bg);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-sm);
        }

        .os-panel {
            display: none;
        }

        .os-panel.active {
            display: block;
        }

        .tutorial-note {
            background: var(--color-accent-light);
            border: 1px solid #bfdbfe;
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
            margin-top: 12px;
        }
    </style>
</head>
<body>

    <!-- ============ Top Nav (shown on dashboard) ============ -->
    <nav id="mainHeader" class="topnav hidden">
        <div class="topnav-brand">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2"/>
                <rect x="2" y="14" width="20" height="8" rx="2"/>
                <circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/>
            </svg>
            VM Provisioner
        </div>
        <div class="topnav-right">
            <span class="topnav-user" id="userName"></span>
            <button class="btn btn-ghost btn-sm" onclick="logout()">Log out</button>
        </div>
    </nav>

    <!-- ============ Login Page ============ -->
    <div id="loginPage" class="auth-wrapper">
        <div class="auth-box">
            <div class="auth-header">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="8" rx="2"/>
                    <rect x="2" y="14" width="20" height="8" rx="2"/>
                    <circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/>
                </svg>
                <h1>VM Provisioner</h1>
                <p>Sign in to manage your instances</p>
            </div>
            <div class="auth-card">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label" for="loginName">Username</label>
                        <input type="text" id="loginName" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Sign in</button>
                </form>
            </div>
            <div class="auth-footer">
                Don't have an account? <a onclick="showSignup()">Create one</a>
            </div>
        </div>
    </div>

    <!-- ============ Signup Page ============ -->
    <div id="signupPage" class="auth-wrapper hidden">
        <div class="auth-box">
            <div class="auth-header">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="20" height="8" rx="2"/>
                    <rect x="2" y="14" width="20" height="8" rx="2"/>
                    <circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/>
                </svg>
                <h1>Create account</h1>
                <p>Get started with VM Provisioner</p>
            </div>
            <div class="auth-card">
                <form onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label class="form-label" for="signupName">Username</label>
                        <input type="text" id="signupName" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Choose a password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create account</button>
                </form>
            </div>
            <div class="auth-footer">
                Already have an account? <a onclick="showLogin()">Sign in</a>
            </div>
        </div>
    </div>

    <!-- ============ API Key Display (after signup) ============ -->
    <div id="apiKeyPage" class="auth-wrapper hidden">
        <div class="auth-box">
            <div class="auth-header">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                </svg>
                <h1>Your API key</h1>
                <p>Save this key securely. It will only be shown once.</p>
            </div>
            <div class="auth-card">
                <div class="alert alert-warning">
                    Copy this key now and store it in a safe place. You will not be able to see it again after leaving this page.
                </div>
                <div class="api-key-block" id="newApiKey"></div>
                <button class="btn btn-primary btn-full" onclick="saveApiKey()">Continue to dashboard</button>
            </div>
        </div>
    </div>

    <!-- ============ Dashboard ============ -->
    <div id="dashboard" class="hidden">
        <div class="container">
            <div class="dashboard-grid">

                <!-- Create VM Form -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Create instance</span>
                    </div>
                    <div class="card-body">
                        <form id="createForm" onsubmit="createVM(event)">
                            <div class="form-group">
                                <label class="form-label" for="vmName">Instance name</label>
                                <input type="text" id="vmName" placeholder="e.g. web-server-01" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="imageType">Operating system</label>
                                <select id="imageType" required>
                                    <option value="">Loading images...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                                    <label class="form-label" for="sshKey" style="margin-bottom:0;">SSH public key</label>
                                    <button type="button" class="btn btn-ghost btn-sm" onclick="openSSHTutorial()" style="font-size:12px; padding:2px 8px; color:var(--color-accent);">
                                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        How to generate
                                    </button>
                                </div>
                                <textarea id="sshKey" placeholder="ssh-rsa AAAAB3NzaC1yc2E..." required></textarea>
                                <div class="form-hint">Paste your public key for SSH access to the instance.</div>
                            </div>

                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div class="form-group">
                                    <label class="form-label" for="memoryMb">Memory (MB)</label>
                                    <input type="number" id="memoryMb" value="512" min="256" max="4096" step="256">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="vcpus">vCPUs</label>
                                    <input type="number" id="vcpus" value="1" min="1" max="4">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-full" id="createBtn">Launch instance</button>
                        </form>
                    </div>
                </div>

                <!-- Instances List -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Instances</span>
                        <button class="btn btn-secondary btn-sm" onclick="loadVMs()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                            Refresh
                        </button>
                    </div>

                    <div class="tab-bar">
                        <div class="tab-item active" onclick="switchTab('all', this)">All</div>
                        <div class="tab-item" onclick="switchTab('running', this)">Running</div>
                        <div class="tab-item" onclick="switchTab('shut off', this)">Stopped</div>
                    </div>

                    <div id="vmsContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============ SSH Tutorial Modal ============ -->
    <div id="sshTutorialModal" class="modal-overlay" onclick="closeSSHTutorial(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title">Generate an SSH key pair</span>
                <button class="modal-close" onclick="closeSSHTutorial(event)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="os-tabs">
                    <button class="os-tab active" onclick="switchOSTab('unix', this)">macOS / Linux</button>
                    <button class="os-tab" onclick="switchOSTab('windows', this)">Windows</button>
                </div>

                <!-- macOS / Linux Panel -->
                <div id="panel-unix" class="os-panel active">
                    <div class="tutorial-section">
                        <h3>1. Open Terminal</h3>
                        <p>On macOS, open <strong>Terminal</strong> from Applications &gt; Utilities. On Linux, use your distribution's terminal emulator.</p>
                    </div>

                    <div class="tutorial-section">
                        <h3>2. Generate the key pair</h3>
                        <p>Run the following command. Press Enter to accept the default file location, then set a passphrase (or leave empty).</p>
                        <div class="code-block">ssh-keygen -t ed25519 -C "your_email@example.com"<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                        <p>If your system does not support Ed25519, use RSA instead:</p>
                        <div class="code-block">ssh-keygen -t rsa -b 4096 -C "your_email@example.com"<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                    </div>

                    <div class="tutorial-section">
                        <h3>3. Copy your public key</h3>
                        <p>Print the public key and copy the full output:</p>
                        <div class="code-block">cat ~/.ssh/id_ed25519.pub<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                        <p>Or for RSA:</p>
                        <div class="code-block">cat ~/.ssh/id_rsa.pub<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                    </div>

                    <div class="tutorial-section">
                        <h3>4. Paste into the form</h3>
                        <p>Copy the entire output (starting with <code>ssh-ed25519</code> or <code>ssh-rsa</code>) and paste it into the SSH public key field above.</p>
                    </div>
                </div>

                <!-- Windows Panel -->
                <div id="panel-windows" class="os-panel">
                    <div class="tutorial-section">
                        <h3>Option A: Using Windows 10/11 built-in OpenSSH</h3>
                        <p>Windows 10 (1809+) and Windows 11 include OpenSSH by default.</p>
                        <ol>
                            <li>Open <strong>PowerShell</strong> or <strong>Command Prompt</strong>.</li>
                            <li>Run the following command:</li>
                        </ol>
                        <div class="code-block">ssh-keygen -t ed25519 -C "your_email@example.com"<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                        <ol start="3">
                            <li>Press Enter to accept the default location (<code>C:\Users\YourName\.ssh\id_ed25519</code>).</li>
                            <li>Set a passphrase or leave empty, then press Enter.</li>
                            <li>Display your public key:</li>
                        </ol>
                        <div class="code-block">type %USERPROFILE%\.ssh\id_ed25519.pub<button class="code-copy-btn" onclick="copyCode(this)">Copy</button></div>
                    </div>

                    <div class="tutorial-section">
                        <h3>Option B: Using PuTTYgen</h3>
                        <ol>
                            <li>Download and install <strong>PuTTY</strong> from <a href="https://www.putty.org" target="_blank" rel="noopener" style="color:var(--color-accent);">putty.org</a>.</li>
                            <li>Open <strong>PuTTYgen</strong> from the Start menu.</li>
                            <li>Select <strong>EdDSA</strong> (or RSA with 4096 bits) and click <strong>Generate</strong>.</li>
                            <li>Move your mouse randomly over the blank area to generate entropy.</li>
                            <li>Copy the public key from the text box at the top of the window.</li>
                            <li>Click <strong>Save private key</strong> to save your private key file.</li>
                        </ol>
                    </div>

                    <div class="tutorial-section">
                        <h3>Paste into the form</h3>
                        <p>Copy the entire public key output and paste it into the SSH public key field above.</p>
                    </div>
                </div>

                <div class="tutorial-note">
                    <strong>Important:</strong> Never share your private key. Only paste the <strong>public key</strong> (the file ending in <code>.pub</code>) into the form. The private key stays on your machine and is used automatically when you connect via SSH.
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let currentTab = 'all';
        let apiKey = '';
        let userName = '';
        let serverIp = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadImages();

            apiKey = localStorage.getItem('apiKey');
            userName = localStorage.getItem('userName');

            if (apiKey && userName) {
                showDashboard();
            } else {
                showLogin();
            }
        });

        // ---- Page Navigation ----
        function hideAll() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('apiKeyPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
        }

        function showLogin() {
            hideAll();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function showSignup() {
            hideAll();
            document.getElementById('signupPage').classList.remove('hidden');
        }

        function showApiKey(key) {
            hideAll();
            document.getElementById('apiKeyPage').classList.remove('hidden');
            document.getElementById('newApiKey').textContent = key;
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('userName').textContent = userName;
            loadVMs();
        }

        // ---- Auth Handlers ----
        async function handleLogin(event) {
            event.preventDefault();

            const name = document.getElementById('loginName').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Login failed');
                }

                const data = await response.json();

                localStorage.setItem('apiKey', data.api_key);
                localStorage.setItem('userName', data.name);
                apiKey = data.api_key;
                userName = data.name;

                showDashboard();
                showToast('Welcome back, ' + data.name, 'success');

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();

            const name = document.getElementById('signupName').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const response = await fetch('/auth/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, password })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Signup failed');
                }

                const data = await response.json();
                showApiKey(data.api_key);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('newApiKey').textContent;
            localStorage.setItem('apiKey', key);
            localStorage.setItem('userName', document.getElementById('signupName').value);
            apiKey = key;
            userName = document.getElementById('signupName').value;

            showDashboard();
            showToast('Account created successfully', 'success');
        }

        function logout() {
            localStorage.removeItem('apiKey');
            localStorage.removeItem('userName');
            apiKey = '';
            userName = '';

            document.getElementById('loginName').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupPassword').value = '';

            showLogin();
        }

        // ---- Load Images ----
        async function loadImages() {
            try {
                const response = await fetch('/images');
                const images = await response.json();

                const select = document.getElementById('imageType');
                select.innerHTML = '';

                for (const [key, value] of Object.entries(images)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value.name;
                    select.appendChild(option);
                }
            } catch (error) {
                // Silently fail -- images will load when API is available
            }
        }

        // ---- Load VMs ----
        async function loadVMs() {
            if (!apiKey) {
                showLogin();
                return;
            }

            const container = document.getElementById('vmsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/vms', {
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        showToast('Session expired. Please sign in again.', 'error');
                        return;
                    }
                    throw new Error('Failed to load instances');
                }

                const data = await response.json();
                if (data.server_ip) serverIp = data.server_ip;
                renderVMs(data.vms || []);
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>' + error.message + '</p></div>';
            }
        }

        // ---- Render VMs ----
        function renderVMs(vms) {
            const container = document.getElementById('vmsContainer');

            const filtered = currentTab === 'all' ? vms : vms.filter(v => v.status.toLowerCase() === currentTab);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg><p>No instances found</p></div>';
                return;
            }

            container.innerHTML = '<div class="vm-list">' + filtered.map(vm => {
                const status = vm.status.toLowerCase();
                let badgeClass = 'badge-unknown';
                let badgeLabel = vm.status;
                if (status === 'running') {
                    badgeClass = 'badge-running';
                    badgeLabel = 'Running';
                } else if (status === 'shut off') {
                    badgeClass = 'badge-stopped';
                    badgeLabel = 'Stopped';
                }

                const shortId = vm.id.substring(0, 8);
                const ip = vm.ip || '—';
                const port = vm.port || '—';
                const created = new Date(vm.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                return '<div class="vm-item">' +
                    '<div class="vm-info">' +
                        '<div class="vm-name">' + escapeHtml(vm.name) + '</div>' +
                        '<div class="vm-meta">' +
                            '<span class="vm-meta-item"><span class="vm-meta-label">ID</span> <span class="vm-meta-value">' + shortId + '</span></span>' +
                            '<span class="vm-meta-item"><span class="vm-meta-label">IP</span> <span class="vm-meta-value">' + ip + '</span></span>' +
                            '<span class="vm-meta-item"><span class="vm-meta-label">Port</span> <span class="vm-meta-value">' + port + '</span></span>' +
                            '<span class="vm-meta-item"><span class="vm-meta-label">Created</span> <span class="vm-meta-value">' + created + '</span></span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="vm-right">' +
                        '<span class="badge ' + badgeClass + '"><span class="badge-dot"></span>' + badgeLabel + '</span>' +
                        '<div class="vm-actions">' +
                            '<button class="btn btn-secondary btn-sm" onclick="copySSH(\'' + vm.port + '\', \'' + (vm.username || 'debian') + '\')">Copy SSH</button>' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteVM(\'' + vm.id + '\')">Delete</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('') + '</div>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ---- Tab Switching ----
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            loadVMs();
        }

        // ---- Create VM ----
        async function createVM(event) {
            event.preventDefault();

            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            const data = {
                name: document.getElementById('vmName').value,
                image_type: document.getElementById('imageType').value,
                ssh_key: document.getElementById('sshKey').value,
                memory_mb: parseInt(document.getElementById('memoryMb').value),
                vcpus: parseInt(document.getElementById('vcpus').value)
            };

            try {
                const response = await fetch('/vms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create instance');
                }

                const result = await response.json();
                showToast('Instance "' + result.name + '" created', 'success');

                document.getElementById('vmName').value = '';
                document.getElementById('sshKey').value = '';

                loadVMs();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Launch instance';
            }
        }

        // ---- Delete VM ----
        async function deleteVM(vmId) {
            if (!confirm('Are you sure you want to delete this instance? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/vms/' + vmId, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': apiKey }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete instance');
                }

                showToast('Instance deleted', 'success');
                loadVMs();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ---- Copy SSH Command ----
        function copySSH(port, username) {
            if (!port || port === 'null' || !serverIp) {
                showToast('Connection info not available yet', 'error');
                return;
            }

            const sshCommand = 'ssh -p ' + port + ' ' + username + '@' + serverIp + ' -i ~/.ssh/id_rsa';
            navigator.clipboard.writeText(sshCommand).then(() => {
                showToast('SSH command copied to clipboard', 'success');
            });
        }

        // ---- Toast Notification ----
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ---- SSH Tutorial Modal ----
        function openSSHTutorial() {
            document.getElementById('sshTutorialModal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeSSHTutorial(e) {
            if (e) e.preventDefault();
            document.getElementById('sshTutorialModal').classList.remove('open');
            document.body.style.overflow = '';
        }

        function switchOSTab(os, el) {
            document.querySelectorAll('.os-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.os-panel').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('panel-' + os).classList.add('active');
        }

        function copyCode(btn) {
            const block = btn.parentElement;
            const text = block.textContent.replace('Copy', '').trim();
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied';
                setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeSSHTutorial(e);
        });
    </script>
</body>
</html>
